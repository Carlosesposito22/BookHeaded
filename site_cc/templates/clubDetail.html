{% extends 'base.html' %}
{% load static %}

{% block title %}
    Detail {{ clube.titulo }}
{% endblock title %}

{% block content %}

{% block extracss %}
<style>
* {
    font-family: 'DM Sans', 'sans-serif';
}

.data-holder {
    background-color: rgb(255, 255, 255);
    padding: .8rem;
    border-radius: 1rem;
    z-index: 99;
    height: fit-content;
    width: 100%;
}

.title-n-fav {
    display: flex;
    flex-direction: row;
    gap: 1.5rem;
    align-items: center;
}

.hold-evr {
    margin-top: 3rem;
    display: flex;
    padding: 0rem;
    flex-direction: row;
    justify-content: space-between;
}

.data-progress-holder {
    display: flex;
    flex-direction: column;
    width: 65%;
}

.btn-progress-bar {
    width: 100%;
    display: flex;
    flex-direction: row;
    margin: 0;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.progressbar-holder {
    max-width: 100%;
    min-width: 80%;
}

.holder-title-btn {
    width: fit-content;
    height: fit-content;
    display: flex;
    flex-direction: row;
    gap: 2rem;
    align-items: center;
}

small {
    display: flex;
    flex-direction: row;
    gap: 2rem;
}

h1 {
    font-size: clamp(16px, 4rem, 6rem);
}

.not-adm-items {
    display: flex;
    flex-direction: column;
}

.description-text {
    max-width: 20rem;
}

#createMaratona {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.5rem;
}

.comentarios-container {
    background-color: #f0f0f0;
    max-height: 300px;
    overflow-y: auto;
    padding: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.comentario-item {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ddd;
}

.meu-comentario {
    background-color: #d9d9d9;
    text-align: right;
    padding: 10px;
    border-radius: 8px;
    margin-left: auto;
    max-width: 80%;
    width: fit-content;
}

.outro-comentario {
    background-color: #a9a9a9;
    text-align: left;
    padding: 10px;
    border-radius: 8px;
    margin-right: auto;
    max-width: 80%;
    width: fit-content;
    max-height: fit-content;
}

small {
    display: flex;
    align-items: center;
}

.progress {
    width: 100%;
    background-color: #000000;
    border-radius: 10rem;
    height: 2rem;
}

.progress-bar {
    transition: width 0.6s ease;
    background-color: #0066FF;
    font-weight: bold;
}

.club-data-icons {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

.div-stars {
    width: fit-content;
    font-size: 1.05rem;
    display: flex;
}

.delete-club {
    width: 90%;
    margin-left: 0.5rem;
}

.comentarioholder {
    padding: 0rem 1rem;
}

.comment-n-date {
    display: flex;
    flex-direction: row;
    justify-content: left;
    height: fit-content;
    align-items: center;
    gap: 3rem;
}

#pdocomentario {
    margin: 0;
}

.comment-n-date.right-align {
    justify-content: flex-end;
    text-align: right;
}

.capitulo-atual {
    font-size: large;
}

#setProgress {
    font-size: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    font-weight: bold;
}

.comentario-wrapper {
    display: flex;
    flex-direction: row;
    gap: .8rem;
}

.dropdown-item:hover {
    cursor: pointer;
}

.btn.reluzir {
    border: none;
    border-radius: 1rem;
    font-size: 1.5rem;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    padding-left: 1rem;
    padding-right: 1rem;
    font-weight: 500;
}

.btn.reluzir:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 0 #003b95,
        0 12px 15px rgba(0, 0, 0, 0.3);
}

.btn.reluzir::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(120deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.2));
    transform: rotate(45deg);
    transition: all 0.5s ease;
    z-index: 1;
    opacity: 0;
    pointer-events: none;
}

.btn.reluzir:hover::before {
    opacity: 1;
    left: 100%;
    top: 100%;
}

.btn.reluzir span {
    position: relative;
    z-index: 2;
}

body,
html {
    margin: 0;
    padding: 0;
    overflow: auto;
    height: 100%;
    width: 100%;
}

.modal-dialog {
    overflow: hidden;
}

.overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #0066FF;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1050;
    border-radius: inherit;
}

.overlay-text {
    color: white;
    font-size: 4rem;
    font-weight: bold;
    text-align: center;
    animation: shake 0.4s infinite;
    line-height: 5rem;
}

@keyframes shake {

    0%,
    100% {
        transform: translate(0);
    }

    10% {
        transform: translate(-3px, -3px);
    }

    20% {
        transform: translate(3px, -3px);
    }

    30% {
        transform: translate(-3px, 3px);
    }

    40% {
        transform: translate(3px, 3px);
    }

    50% {
        transform: translate(-3px, 0);
    }

    60% {
        transform: translate(3px, 0);
    }

    70% {
        transform: translate(0, -3px);
    }

    80% {
        transform: translate(0, 3px);
    }
}

.data-n-topclubs {
    display: flex;
    flex-direction: column;
    width: 30%;
    gap: 1rem;
}

.top-books {
    background-color: #0066FF;
    padding: 1rem;
    border-radius: 1rem;
    padding-bottom: 0;
    display: flex;
    justify-content: center;
}

.top-books-li {
    font-size: 18px;
    text-align: center;
    font-weight: 500;
    color: white;
    overflow-y: hidden;
    overflow-x: scroll;
    padding: 0.5rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
    cursor: grab;
    user-select: none;
}


.user-data::-webkit-scrollbar {
    display: none;
}

.top-books-ul {
    list-style-type: none;
    padding: 0;
    display: flex;
    justify-content: center;
    margin-bottom: 0;
    gap: 0.5rem;
    align-items: self-end;
}

#second {
    display: flex;
    flex-direction: column;
}

#first {
    display: flex;
    flex-direction: column;
}


#third {
    display: flex;
    flex-direction: column;
}

.first-place {
    height: 150px;
    background-color: #0052cd !important;
    width: 6rem;
}

.second-place {
    height: 100px;
    background-color: #003b93 !important;
    width: 6rem;
}

.third-place {
    height: 75px;
    background-color: #002d6f !important;
    width: 6rem;
}

.spree-ongoing {
    background-color: #0066FF;
    width: 100%;
}

.spree-informer {
    background-color: #0066FF;
    padding: 1rem;
    font-size: 1.5rem;
    color: white;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
}

.data-n-topbooks {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 30%;
}

@media (max-width: 700px) {

    .data-n-topbooks {
        width: 100% !important;
    }

    .data-progress-holder {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .btn-progress-bar {
        width: 100%;
        align-items: center;
    }

    .hold-evr-exc-admt {
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .data-holder {
        margin-top: 1rem;
        width: 100% !important;
    }

    .container {
        align-items: center;
        justify-content: center;
    }

    .hold-evr {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: fit-content;
    }

    .holder-title-btn {
        flex-direction: column;
        align-items: flex-start;
    }

    .comentarioholder,
    .capitulo-container,
    .comentarios-container,
    .data-holder {
        width: 100%;
    }
}

.small-chart-container {
    width: 250px;
    height: 200px;
    margin: 0 auto;
    display: none;
}

.no-votes-message {
    text-align: center;
    color: #888;
    font-size: 18px;
    display: none;
}

.enquete-title {
    font-size: 1.1rem;
    color: #0d6efd;
    text-decoration: none;
    transition: background-color 0.3s ease;
}

.enquete-title:hover {
    background-color: gray;
}

.enquete-details {
    margin-top: 10px;
}

.modal-header.bg-primary {
    background-color: #0d6efd !important;
    color: #ffffff !important;
}

.modal-title {
    font-size: 1.5rem;
}

#opcoesContainer .input-group {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.input-group .btn-outline-secondary {
    margin-left: 5px;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
}

body{
    padding-bottom: 1rem;
}   
</style>    
{% endblock extracss %}

{% if clube.maratona_ativa %}
    <div class="spree-informer">
        This club is under a reading spree right now <i class="bi bi-info-circle-fill"></i>
    </div>
{% endif %}

<div class="container">
    <div class="hold-evr">
        <div class="data-progress-holder">
            <div class="title-n-fav">
                <h1>{{ clube.titulo }}</h1>
                <button id="favoritar-btn-{{ clube.id }}" class="btn btn-primary" data-clube-id="{{ clube.id }}">
                    {% if user in clube.favoritos.all %}
                    <i class="bi bi-star-fill"></i>
                    {% else %}
                    <i class="bi bi-star"></i>
                    {% endif %}
                </button>
            </div>
            <div class="btn-progress-bar">
                <div class="my-3 progressbar-holder">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar"
                             style="width: {{ progresso_percentual }}%;"
                             aria-valuenow="{{ progresso_percentual }}" aria-valuemin="0" aria-valuemax="100">
                             {{ progresso_percentual }}%
                        </div>
                    </div>
                </div>
                {% if user.is_authenticated and user == clube.moderador %}
                    <button id="setProgress" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#progressModal">Mark Progress</button>
                {% endif %}
            </div>

            <hr>

            <div class="capitulo-container" style="background-color: #e0e0e0; padding: 10px; border-top-left-radius: 8px; border-top-right-radius: 8px; margin-top: 1rem;">
                <div class="my-3 d-flex justify-content-between align-items-center">
                    {% if clube.maratona_ativa %}
                        <span class="capitulo-atual">Capítulo atual: <span id="capituloAtualSpan">Em maratona</span></span>
                    {% else %}
                        <span class="capitulo-atual">Capítulo atual: <span id="capituloAtualSpan">{{ clube.progresso_atual }}</span></span>
                    {% endif %}
                    <button type="button" id="ver-enquetes" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#enquetesModal">
                        See Polls
                    </button>
                </div>
            </div>
            
            <div class="comentarios-container" id="comentariosContainer">
                {% if not clube.comentarios.all %}
                    No chat was started yet...
                {% else %}
                    {% for comentario in clube.comentarios.all|slice:"-8:" %}
                    <div class="comentario-wrapper">
                        {% if comentario.user == user %}
                            <div class="comentario-item meu-comentario">
                                <div class="comentario-conteudo">
                                    <strong>{{ comentario.user.username }}</strong>  
                                    <div class="comment-n-date right-align">
                                        <p id="pdocomentario" class="datap">{{ comentario.data|date:"d/m" }} at {{ comentario.data|date:"H:i" }}</p>
                                        <p id="pdocomentario">{{ comentario.comentario }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="comentario-foto foto-direita">
                                <a href="{% url 'profile' user.id %}">
                                    <img src="{% if user.profile.icone %}{% static user.profile.icone %}{% else %}{% static 'images/icon3.svg' %}{% endif %}" alt="foto de usuário" width="40rem">
                                </a>
                            </div>
                        {% else %}
                            <div class="comentario-foto foto-esquerda">
                                <a href="{% url 'profile' comentario.user.id %}">
                                    <img src="{% if comentario.user.profile.icone %}{% static comentario.user.profile.icone %}{% else %}{% static 'images/icon3.svg' %}{% endif %}" alt="foto de usuário" width="40rem">
                                </a>
                            </div>
                            <div class="comentario-item outro-comentario">
                                <div class="comentario-conteudo">
                                    <strong>{{ comentario.user.username }}</strong>  
                                    <div class="comment-n-date">
                                        <p id="pdocomentario">{{ comentario.comentario }}</p>
                                        <p id="pdocomentario" class="datap">{{ comentario.data|date:"d/m" }} at {{ comentario.data|date:"H:i" }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div class="comentarioholder" style="background-color: #e0e0e0; padding: 4ypx; border-bottom-left-radius: 8px;border-bottom-right-radius: 8px;">
                <form action="{% url 'add_comentario' clube.pk %}" method="POST" class="my-4 d-flex align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="clube_id" value="{{ clube.pk }}">
                    <textarea name="comentario" id="comentario" required class="form-control me-2" rows="1"
                        style="height: 38px;"></textarea>
                    <button type="submit" class="btn btn-primary btn-sm" style="height: 38px;" name="comentar">Comment</button>
                </form>
            </div>         
        </div>

        <div class="modal fade" id="topLivrosModal-{{ clube.id }}" tabindex="-1" aria-labelledby="topLivrosLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="topLivrosLabel">Favoritos do Clube:</h3>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="topLivrosContent-{{ clube.id }}">
                            <p>Carregando os livros...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="addTopLivrosModal-{{ clube.id }}" tabindex="-1" aria-labelledby="addTopLivrosModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTopLivrosModalLabel">Edit Favourite Books</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="{% url 'add_top_livros' clube.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="topLivros" class="form-label">Add Books (divide by line)</label>
                                <textarea class="form-control" id="topLivros" name="top_livros" rows="3" required>{{ clube.top_livros }}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" name="edit-book-btn">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="updateModal-{{ clube.id }}" tabindex="-1" aria-labelledby="updateModalLabel-{{ clube.id }}" aria-hidden="true" data-modalidade-id="{{ clube.modalidade.id }}" data-categoria-id="{{ clube.categoria.id }}">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="display: flex; flex-direction: row; align-items: center;">
                        <div class="text-n-icon" style="display: flex; flex-direction: row; align-items: center; gap: 1rem;">
                            <i class="bi bi-pencil-square" style="color: #0066FF; font-size: 1.5rem;"></i>
                            <h3 class="text-center" style="margin: 0;"> Edit Club Details</h3>
                        </div>
                        
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if user.is_authenticated and user.id == clube.moderador.id %}
                        <div class="container">
                            <div class="holder">
                                
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <form method="post" action="{% url 'updateClube' clube.pk %}">
                                                {% csrf_token %}
                                                <label for="titulo">Title:</label>
                                                <input type="text" id="titulo" name="titulo" value="{{ clube.titulo }}" class="form-control" required>

                                                <label for="modalidade">Modality:</label>
                                                <select id="modalidade" name="modalidade" class="form-control">
                                                    <option value="">Choose a Modality</option>
                                                    {% for modalidade in modalidades %}
                                                        <option value="{{ modalidade.id }}" {% if clube.modalidade and clube.modalidade.id == modalidade.id %}selected{% endif %}>
                                                            {{ modalidade.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>

                                                <label for="categoria">Genre:</label>
                                                <select id="categoria" name="categoria" class="form-control">
                                                    <option value="">Choose a Genre</option>
                                                    {% for categoria in categorias %}
                                                        <option value="{{ categoria.id }}" {% if clube.categoria and clube.categoria.id == categoria.id %}selected{% endif %}>
                                                            {{ categoria.nome }}
                                                        </option>
                                                    {% endfor %}
                                                </select>

                                                <label for="descricao">Description:</label>
                                                <textarea id="descricao" name="descricao" class="form-control" required>{{ clube.descricao }}</textarea>

                                                <label for="privado">Private:</label>
                                                <input type="checkbox" id="privado" name="privado" {% if clube.privado %}checked{% endif %}>

                                                <div class="modal-footer">
                                                    <button class="btn btn-primary btn-sm" type="submit" name="atualizar">Update</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de criação de enquete -->
        <div class="modal fade" id="criarEnqueteModal" tabindex="-1" aria-labelledby="criarEnqueteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="criarEnqueteModalLabel">Create Poll</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="{% url 'criar_enquete' clube.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="enqueteTitulo" class="form-label fw-bold">Poll Title</label>
                                <input type="text" class="form-control" id="enqueteTitulo" name="titulo" required>
                            </div>
                            <div class="mb-3">
                                <label for="enquetePrazo" class="form-label fw-bold">Deadline</label>
                                <input type="date" class="form-control" id="enquetePrazo" name="prazo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Options</label>
                                <div id="opcoesContainer">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" name="opcoes" id="opcoes-enquete" placeholder="Opção 1" required>
                                        <button type="button" name="btn-mais" class="btn btn-outline-secondary" onclick="adicionarOpcao()">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="sair-enquete" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" id="save-enquete" class="btn btn-primary">Criar Enquete</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal de Enquetes -->
        <div class="modal fade" id="enquetesModal" tabindex="-1" aria-labelledby="enquetesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="enquetesModalLabel">Club Polls</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% if enquetes_ativas %}
                            <div id="enqueteListContainer">
                                {% for enquete in enquetes_ativas %}
                                    <button class="btn btn-outline-primary w-100 text-start mb-2 fw-bold enquete-title" name="nova-enquete"
                                            data-enquete-id="{{ enquete.id }}" onclick="toggleEnqueteDetails({{ enquete.id }})">
                                        {{ enquete.titulo }}
                                    </button>
                                    <div id="enqueteDetails-{{ enquete.id }}" class="enquete-details collapse p-3 border rounded bg-light">
                                        <p class="text-muted">Expires in: {{ enquete.prazo|date:"d/m/Y" }}</p>
                                        <form id="votacaoForm-{{ enquete.id }}" onsubmit="votarEnquete(event, {{ enquete.id }})">
                                            {% csrf_token %}
                                            {% for opcao in enquete.opcoes.all %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="opcao_id" value="{{ opcao.id }}" id="opcao-{{ opcao.id }}" required>
                                                    <label class="form-check-label" for="opcao-{{ opcao.id }}">{{ opcao.texto }}</label>
                                                </div>
                                            {% endfor %}
                                            <button type="submit" name="btn-vote" class="btn btn-success mt-3">Vote</button>
                                        </form>
                                        <div id="votacaoMensagem-{{ enquete.id }}" class="mt-2"></div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-center text-muted">There are no active polls.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Resultados das Enquetes -->
        <div class="modal fade" id="resultadosEnquetesModal" tabindex="-1" aria-labelledby="resultadosEnquetesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="resultadosEnquetesModalLabel">Poll Results</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="resultadosContainer">
                            {% if enquetes_ativas %}
                                {% for enquete in enquetes_ativas %}
                                    <button class="btn btn-outline-primary w-100 text-start mb-2 fw-bold"
                                            data-enquete-id="{{ enquete.id }}" onclick="toggleChartVisibility({{ enquete.id }})">
                                        {{ enquete.titulo }}
                                    </button>
                                    <p class="text-muted ms-2">Data de Encerramento: {{ enquete.prazo|date:"d/m/Y" }}</p>

                                    <div id="noVotesMessage-{{ enquete.id }}" class="no-votes-message text-muted" style="display: none;">
                                        No voting was done in this poll!
                                    </div>
                                    
                                    <div id="chartContainer-{{ enquete.id }}" class="small-chart-container collapse">
                                        <canvas id="chart-{{ enquete.id }}" width="200" height="150"></canvas>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-center text-muted">No Poll was found.</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" name="btn-fechar-enquete-resultado" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        {% include 'modal_delete.html' %}
        {% include 'modal_avaliar.html' %}
        {% include 'pedidos.html' %}
        {% include 'modal_SairDoClube.html' %}

        <div class="data-n-topbooks">
            <div class="data-holder shadow"> 
                <div class="club-data-icons">
                    <h3><strong>Club Data</strong></h3>
                    {% if user.is_authenticated %}
                       
                        {% if user == clube.moderador %}
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary engine" id="engine" data-bs-toggle="dropdown" style="border-radius: 0.5rem;"><i class="bi bi-gear-wide-connected"></i></button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#updateModal-{{ clube.id }}" name="editclub">Edit Club</a></li>
                                <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#addTopLivrosModal-{{ clube.id }}" name="editbooks">Edit Top Books</a></li>
                                    {% if clube.privado %}
                                        <li><a href="#" id="request" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#pedidosModal">Requests</a></li>
                                    {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a href="#" class="btn btn-danger delete-club" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ clube.id }}">Delete Club</a></li>
                            </ul>
                          </div>
                        {% endif %}
                    {% endif %}
                </div> 
    
                <hr>
                <p class="text-break description-text"><strong>Description: </strong>{{ clube.descricao|safe }}</p>
                <p><strong>Foundation:  </strong>{{ clube.dataDeCriacao|date:"d/m/Y" }}</p>
                <p><strong>Genre:</strong> {{ clube.categoria.nome }}</p>
                <p><strong>Modality:</strong> {{ clube.modalidade.nome }}</p>
                <p><strong>Club Privacy:</strong> {% if clube.privado %}Private{% else %}Public{% endif %}</p>
                <p><strong>Members:</strong> {{ clube.contar_membros }}</p>
                <p class="div-stars"><strong>Rating:&nbsp;</strong>{% autoescape off %}{{ clube.estrelas_avaliacoes }}{% endautoescape %}</p>
                <p>
                    <strong>Total Sprees:</strong> {{ total_maratona_finalizadas }} 
                    <i class="bi bi-eye-fill" id="listarHistorico" data-clube-id="{{ clube.id }}" style="cursor: pointer;"></i>
                </p>
                <p>
                    <strong>Total Polls:</strong> {{ clube.enquetes.count }}
                    <i class="bi bi-bar-chart-fill" id="listarResultadosEnquetes" data-clube-id="{{ clube.id }}" style="cursor: pointer;"></i>
                </p>
                <hr>
                {% if user != clube.moderador %}
                    <button type="button" class="btn btn-primary" name="avaliarbtn" data-bs-toggle="modal" data-bs-target="#avaliarModal-{{ clube.id }}">
                        Rate Club
                    </button>
                    &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#sairDoClubeModal-{{ clube.id }}" id="sair-do-clube-btn">
                        Leave Club
                    </button>
                    {% if error_message %}
                        <div class="alert alert-danger" id="erro-avaliar">{{ error_message }}</div>
                    {% endif %}
                {% else %}
                    {% if clube.maratona_ativa %}
                        <button id="createMaratona" data-clube-id="{{ clube.id }}" class="btn btn-primary btn-sm reluzir" data-bs-toggle="modal" data-bs-target="#maratonaModal">Edit Spree <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i></button>
                    {% else %}
                        <button id="createMaratona" data-clube-id="{{ clube.id }}" class="btn btn-primary btn-sm reluzir" data-bs-toggle="modal" data-bs-target="#maratonaModal">Start Spree</button>
                    {% endif %}
                        <br>
                        <button type="button" name="criar-enquete" class="btn btn-primary btn-sm reluzir" data-bs-toggle="modal" data-bs-target="#criarEnqueteModal">Nova enquete</button>
                {% endif %}
            </div>
            {% include 'modal_livros.html' %}
        </div>
        
    </div>

    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">Define Progress</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="progressForm">
                        <div class="mb-3">
                            <label for="currentPage" class="form-label">Current Chapter</label>
                            <input type="number" class="form-control" id="currentcapitulo" value="{{ clube.progresso_atual }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="totalPages" class="form-label">Total Chapters</label>
                            <input type="number" class="form-control" id="totalcapitulo" value="{{ clube.total_capitulos }}" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-url="{% url 'atualizar_progresso' clube.pk %}" data-bs-dismiss="modal" id="saveProgress">Salvar Progresso</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="maratonaModal" tabindex="-1" aria-labelledby="maratonaModalLabel" aria-hidden="true">
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1040; pointer-events: none;"></canvas>
        <div class="modal-dialog">
            <div class="modal-content" style="position: relative;">
                <div class="modal-body" style="position: relative; overflow: hidden;">
                    <div style="position: relative; z-index: 2; color: black;">
                        <form id="maratonaForm">
                            <div class="mb-3">
                                <label for="nomeMaratona" class="form-label">Spree Name</label>
                                <input type="text" class="form-control" id="nomeMaratona" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataInicio" class="form-label">Starting Date</label>
                                <input type="date" class="form-control" id="dataInicio" required>
                            </div>
                            <div class="mb-3">
                                <label for="dataFim" class="form-label">Ending Date</label>
                                <input type="date" class="form-control" id="dataFim" required>
                            </div>
                            <div class="mb-3">
                                <label for="capituloAtual" class="form-label">Current Chapter</label>
                                <input type="number" class="form-control" id="capituloAtual" value="{{ clube.progresso_atual }}" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="capituloFinal" class="form-label">Ending Chapter of the Spree</label>
                                <input type="number" class="form-control" id="capituloFinal" required>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="finalizarMaratona">End Spree</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="saveMaratona">Save Spree</button>
                </div>
            </div>
        </div>
    </div>



    
    <div class="modal fade" id="historicoMaratonasModal" tabindex="-1" aria-labelledby="historicoMaratonasModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="historicoMaratonasModalLabel">Spree History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="width: 25%;">Spree Name</th>
                                    <th scope="col" class="text-nowrap" style="width: 15%;">Start Date</th>
                                    <th scope="col" class="text-nowrap" style="width: 15%;">End Date</th>
                                    <th scope="col">Duration</th>
                                    <th scope="col">Starting Chapter</th>
                                    <th scope="col">Ending Chapter</th>
                                    <th scope="col">Read Chapters</th>
                                </tr>
                            </thead>
                            <tbody id="historicoBody">
                                <!-- Os dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>   
    </div>
    
    
    
</div>

<!--<script src="{% static 'js/clubDetail.js' %}"></script> -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function adicionarOpcao() {
    const opcoesContainer = document.getElementById('opcoesContainer');
    const novaOpcao = document.createElement('div');
    novaOpcao.classList.add('input-group', 'mb-2');
    novaOpcao.innerHTML = `
        <input type="text" class="form-control" name="opcoes" id="opcoes1" placeholder="New Option" required>
        <button type="button" class="btn btn-outline-danger" onclick="removerOpcao(this)">-</button>
    `;
    opcoesContainer.appendChild(novaOpcao);
}

function removerOpcao(button) {
    button.parentElement.remove();
}

function votarNaOpcao(enqueteId, opcaoId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/votar/${enqueteId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 'opcao_id': opcaoId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const votosContador = document.querySelector(`#votos-contador-${opcaoId}`);
            votosContador.textContent = parseInt(votosContador.textContent) + 1;
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao registrar o voto:', error);
    });
}

function toggleEnqueteDetails(enqueteId) {
    document.querySelectorAll('.enquete-details').forEach(element => {
        if (element.getAttribute('id') !== `enqueteDetails-${enqueteId}`) {
            element.classList.remove('show');
        }
    });

    const details = document.getElementById(`enqueteDetails-${enqueteId}`);
    details.classList.toggle('show');
}

function votarEnquete(event, enqueteId) {
    event.preventDefault();
    const form = document.getElementById(`votacaoForm-${enqueteId}`);
    const opcaoSelecionada = form.querySelector('input[name="opcao_id"]:checked');
    const mensagemContainer = document.getElementById(`votacaoMensagem-${enqueteId}`);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!opcaoSelecionada) {
        mensagemContainer.innerHTML = `<div class="alert alert-danger">Por favor, selecione uma opção para votar.</div>`;
        return;
    }

    const opcaoId = opcaoSelecionada.value;

    fetch(`/votar/${enqueteId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 'opcao_id': opcaoId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mensagemContainer.innerHTML = `<div class="alert alert-success">Voto registrado com sucesso!</div>`;
            form.style.display = 'none';
            setTimeout(() => location.reload(), 1500);
        } else {
            mensagemContainer.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Erro ao votar:', error);
        mensagemContainer.innerHTML = `<div class="alert alert-danger">Ocorreu um erro. Tente novamente.</div>`;
    });
}

document.getElementById('listarResultadosEnquetes').addEventListener('click', function() {
    const clubeId = this.getAttribute('data-clube-id');
    fetchResultadosEnquetes(clubeId);
});

function fetchResultadosEnquetes(clubeId) {
    fetch(`/clube/${clubeId}/resultados_enquetes/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('resultadosContainer');
            container.innerHTML = '';

            if (data.success) {
                data.enquetes.forEach(enquete => {
                    const enqueteTitle = document.createElement('button');
                    enqueteTitle.classList.add('btn', 'btn-outline-primary', 'mb-2', 'w-100');
                    enqueteTitle.textContent = enquete.titulo;
                    enqueteTitle.setAttribute('data-enquete-id', enquete.id);
                    enqueteTitle.addEventListener('click', function() {
                        toggleChartVisibility(enquete.id, enquete.prazo);
                    });
                    container.appendChild(enqueteTitle);

                    const totalVotes = enquete.opcoes.reduce((sum, opcao) => sum + opcao.votos, 0);
                    if (totalVotes === 0) {
                        const noVotesMessage = document.createElement('div');
                        noVotesMessage.classList.add('no-votes-message');
                        noVotesMessage.setAttribute('id', `noVotesMessage-${enquete.id}`);
                        noVotesMessage.textContent = 'Nenhum voto foi feito nesta enquete!';
                        container.appendChild(noVotesMessage);
                    } else {
                        const chartContainer = document.createElement('div');
                        chartContainer.classList.add('small-chart-container');
                        chartContainer.setAttribute('id', `chartContainer-${enquete.id}`);
                        chartContainer.style.display = 'none';
                        chartContainer.innerHTML = `<canvas id="chart-${enquete.id}" width="200" height="150"></canvas>`;
                        container.appendChild(chartContainer);

                        const ctx = document.getElementById(`chart-${enquete.id}`).getContext('2d');
                        const labels = enquete.opcoes.map(opcao => opcao.texto);
                        const votes = enquete.opcoes.map(opcao => opcao.votos);
                        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

                        const isHorizontal = labels.length > 4;
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Votos',
                                    data: votes,
                                    backgroundColor: colors.slice(0, labels.length),
                                    borderColor: '#333333',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                indexAxis: isHorizontal ? 'y' : 'x',
                                plugins: {
                                    legend: { display: isHorizontal }
                                },
                                scales: isHorizontal ? {
                                    x: {
                                        beginAtZero: true,
                                        grid: { display: false }
                                    },
                                    y: {
                                        grid: { display: false }
                                    }
                                } : {
                                    x: {
                                        grid: { display: false }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        grid: { display: false }
                                    }
                                }
                            }
                        });
                    }
                });

                const modal = new bootstrap.Modal(document.getElementById('resultadosEnquetesModal'));
                modal.show();
            } else {
                container.innerHTML = '<p>Nenhuma enquete foi encontrada.</p>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
        });
}

function toggleChartVisibility(enqueteId, prazo) {
    document.querySelectorAll('.small-chart-container, .no-votes-message, .prazo-element').forEach(element => {
        if (element.getAttribute('id') !== `chartContainer-${enqueteId}` && 
            element.getAttribute('id') !== `noVotesMessage-${enqueteId}` && 
            element.getAttribute('id') !== `prazo-${enqueteId}`) {
            element.style.display = 'none';
        }
    });

    const chartContainer = document.getElementById(`chartContainer-${enqueteId}`);
    const noVotesMessage = document.getElementById(`noVotesMessage-${enqueteId}`);

    let prazoElement = document.getElementById(`prazo-${enqueteId}`);
    if (!prazoElement && chartContainer) {
        prazoElement = document.createElement('p');
        prazoElement.classList.add('text-muted', 'ms-2', 'prazo-element');
        prazoElement.setAttribute('id', `prazo-${enqueteId}`);
        prazoElement.textContent = `Data de Encerramento: ${prazo}`;
        chartContainer.parentNode.insertBefore(prazoElement, chartContainer);
    }

    if (chartContainer) {
        const isCurrentlyHidden = chartContainer.style.display === 'none' || chartContainer.style.display === '';
        chartContainer.style.display = isCurrentlyHidden ? 'block' : 'none';
        if (prazoElement) prazoElement.style.display = isCurrentlyHidden ? 'block' : 'none';
        if (noVotesMessage) noVotesMessage.style.display = 'none';
    } else if (noVotesMessage) {
        noVotesMessage.style.display = 'block';
        if (prazoElement) prazoElement.style.display = 'block';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getCSRFToken() {
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    return csrfToken;
}

document.getElementById('saveProgress').addEventListener('click', function () {
    const currentCapitulo = parseInt(document.getElementById('currentcapitulo').value);
    const totalCapitulos = parseInt(document.getElementById('totalcapitulo').value);

    if (currentCapitulo > 0 && totalCapitulos > 0) {
        if (currentCapitulo > totalCapitulos) {
            alert('O capítulo atual não pode ser maior que o total de capítulos.');
        } else {
            fetch(`{% url 'atualizar_progresso' clube.pk %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_capitulo: currentCapitulo,
                    total_capitulos: totalCapitulos
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); 
                if (data.success) {
                    const progressPercent = (currentCapitulo / totalCapitulos) * 100;
                    document.getElementById('progressBar').style.width = progressPercent + '%';
                    document.getElementById('progressBar').setAttribute('aria-valuenow', progressPercent);
                    document.getElementById('progressBar').innerText = Math.round(progressPercent) + '%';

                    document.getElementById('capituloAtualSpan').innerText = currentCapitulo;

                    $('#progressModal').modal('hide');
                } else {
                    alert('Erro ao salvar progresso.');
                }
            });
        }
    } else {
        alert('Por favor, insira valores positivos para os capítulos.');
    }
});

document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('saveProgress').addEventListener('click', function () {
        const currentCapitulo = parseInt(document.getElementById('currentcapitulo').value);
        const totalCapitulos = parseInt(document.getElementById('totalcapitulo').value);
        const url = this.getAttribute('data-url');

        if (currentCapitulo > 0 && totalCapitulos > 0) {
            if (currentCapitulo > totalCapitulos) {
                alert('O capítulo atual não pode ser maior que o total de capítulos.');
            } else {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_capitulo: currentCapitulo,
                        total_capitulos: totalCapitulos
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data); 
                    if (data.success) {
                        const progressPercent = (currentCapitulo / totalCapitulos) * 100;
                        const progressBar = document.getElementById('progressBar');
                        
                        progressBar.style.width = progressPercent + '%';
                        progressBar.setAttribute('aria-valuenow', progressPercent);
                        progressBar.innerText = Math.round(progressPercent) + '%';
    
                        document.getElementById('capituloAtualSpan').innerText = currentCapitulo;
    
                        if (progressPercent === 100) {
                            progressBar.classList.add('progress-bar-green');
                        } else {
                            progressBar.classList.remove('progress-bar-green');
                            progressBar.style.backgroundColor = '#4169E1';
                        }

                        $('#progressModal').modal('hide');
                    } else {
                        alert('Erro ao salvar progresso.');
                    }
                });
            }
        } else {
            alert('Por favor, insira valores positivos para os capítulos.');
        }
    });
});

document.querySelectorAll('[id^="topLivrosModal-"]').forEach(function (modal) {
    modal.addEventListener('show.bs.modal', function (event) {
        const clubeId = event.target.getAttribute('id').split('-')[1];
        const modalContent = document.getElementById(`topLivrosContent-${clubeId}`);
        
        fetch(`/clube/${clubeId}/top-livros/`)
            .then(response => response.text())
            .then(html => {
                modalContent.innerHTML = html;
            })
            .catch(err => {
                modalContent.innerHTML = '<p>Erro ao carregar os top livros.</p>';
            });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[id^="favoritar-btn-"]').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var clubeId = this.getAttribute('data-clube-id');
            var url = `/clube/favoritar/${clubeId}/`;
            var buttonElement = this;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisição: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.favoritado) {
                    buttonElement.innerHTML = '<i class="bi bi-star-fill"></i>';
                } else {
                    buttonElement.innerHTML = '<i class="bi bi-star"></i>';
                }
            })
            .catch(error => console.error('Erro:', error));
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
document.querySelectorAll('[id^="updateModal-"]').forEach(function (modal) {
    modal.addEventListener('show.bs.modal', function (event) {
        const clubeId = event.target.getAttribute('id').split('-')[1];
        const modalidadeSelect = modal.querySelector('#modalidade');
        const categoriaSelect = modal.querySelector('#categoria');

        fetch('/api/modalidades/')
            .then(response => response.json())
            .then(modalidades => {
                modalidadeSelect.innerHTML = '<option value="">Selecione uma modalidade</option>';
                modalidades.forEach(modalidade => {
                    const option = document.createElement('option');
                    option.value = modalidade.id;
                    option.textContent = modalidade.nome;
                    
                    if (modalidade.id == modal.getAttribute('data-modalidade-id')) {
                        option.selected = true;
                    }
                    modalidadeSelect.appendChild(option);
                });
            })
            .catch(err => console.error('Erro ao carregar modalidades:', err));

        fetch('/api/categorias/')
            .then(response => response.json())
            .then(categorias => {
                categoriaSelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nome;
                    
                    if (categoria.id == modal.getAttribute('data-categoria-id')) {
                        option.selected = true;
                    }
                    categoriaSelect.appendChild(option);
                });
            })
            .catch(err => console.error('Erro ao carregar categorias:', err));
    });
});
});

const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let cw = canvas.width = window.innerWidth;
  let ch = canvas.height = window.innerHeight;
  const rand = (min, max) => (min + Math.random() * (max - min));
  class SpeedLine {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.speed = rand(2, 4);
      this.life = this.curLife = rand(500, 900);
      this.alpha = rand(0.25, 1);
      this.angle = Math.PI * rand(0, 2);
      this.size = rand(20, 40);
      this.inRadius = rand(200, 400);
      this.outRadius = cw;
    }
    update() {
      this.curLife -= this.speed;
      this.inRadius += this.speed * 4;
      this.alpha *= this.curLife / this.life;
      this.size *= this.curLife / this.life;
      this.draw();
    }
    draw() {
      const { x, y, size, angle, alpha } = this,
        { inRadius, outRadius } = this;
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(angle);
      ctx.beginPath();
      ctx.moveTo(0, inRadius);
      ctx.lineTo(size, outRadius);
      ctx.lineTo(-size, outRadius);
      ctx.closePath();
      ctx.fillStyle = `rgba(255,255,255, ${alpha})`;
      ctx.fill();
      ctx.restore();
    }
  }
  const lines = [];
  const MAX_LINES = 300;
  function updateLines() {
    lines.forEach((line, i) => {
      if (!line || line.curLife < 0) lines[i] = new SpeedLine(cw / 2, ch / 2);
      lines[i].update();
    });
  }
  for (let i = 0; i < MAX_LINES; i++) {
    lines[i] = new SpeedLine(cw / 2, ch / 2);
  }
  function animate() {
    requestAnimationFrame(animate);
    ctx.clearRect(0, 0, cw, ch);
    updateLines();
  }
  animate();


document.getElementById('listarHistorico').addEventListener('click', function() {
    const clubeId = this.getAttribute('data-clube-id');
    listarHistorico(clubeId);
});

function listarHistorico(clubeId) {
    fetch(`/clube/${clubeId}/listar_historico_maratona/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const historicoBody = document.getElementById('historicoBody');
            historicoBody.innerHTML = '';

            if (data.success) {
                if (data.historico.length === 0) {
                    historicoBody.innerHTML = '<tr><td colspan="5">Nenhum histórico encontrado.</td></tr>';
                } else {
                    data.historico.forEach(historico => {
                        const diasDuracao = calcularDuracao(historico.data_inicio, historico.data_fim);
                        const totalCapitulos = calcularTotalCapitulos(historico.capitulo_final, historico.capitulo_atual);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${historico.nome_maratona}</td>
                            <td>${historico.data_inicio}</td>
                            <td>${historico.data_fim}</td>
                            <td>${diasDuracao} dias</td>
                            <td>${historico.capitulo_atual}</td>
                            <td>${historico.capitulo_final}</td>
                            <td>${totalCapitulos}</td>
                        `;
                        historicoBody.appendChild(row);
                    });
                }

                const modal = new bootstrap.Modal(document.getElementById('historicoMaratonasModal'));
                modal.show();
            } else {
                historicoBody.innerHTML = '<tr><td colspan="5">Nenhum histórico encontrado.</td></tr>';
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
        });
}


    document.getElementById('finalizarMaratona').addEventListener('click', function() {
    const createButton = document.getElementById('createMaratona');
    const clubeId = createButton.getAttribute('data-clube-id');

    fetch(`/clube/${clubeId}/finalizar_maratona/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Maratona finalizada com sucesso!');
            location.reload(true);
        } else {
            alert('Erro ao finalizar maratona.');
            console.error('Erro:', data);
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
    });
    location.reload(true);
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function carregarDadosMaratona(clubeId) {
    fetch(`/clube/${clubeId}/detalhes_maratona/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.maratona_ativa) {
                    document.getElementById('nomeMaratona').value = data.nome_maratona;
                    document.getElementById('dataFim').value = data.data_fim;
                    document.getElementById('capituloFinal').value = data.capitulo_final;
                    document.getElementById('finalizarMaratona').style.display = 'block';
                    document.getElementById('saveMaratona').innerText = 'Salvar Mudança';
                } else {
                    document.getElementById('nomeMaratona').value = '';
                    document.getElementById('dataFim').value = '';
                    document.getElementById('capituloFinal').value = '';
                    document.getElementById('finalizarMaratona').style.display = 'none';
                    document.getElementById('saveMaratona').innerText = 'Criar Maratona';
                }
            } else {
                alert('Erro ao carregar dados da maratona.');
                console.error('Erro:', data);
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
        });
}


document.getElementById('saveMaratona').addEventListener('click', function() {
    const createButton = document.getElementById('createMaratona');
    const clubeId = createButton.getAttribute('data-clube-id');
    
    const nomeMaratona = document.getElementById('nomeMaratona').value;
    const dataFim = document.getElementById('dataFim').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const capituloFinal = parseInt(document.getElementById('capituloFinal').value, 10);
    const capituloAtual = parseInt(document.getElementById('capituloAtual').value, 10);

    if (nomeMaratona === '') {
        alert('O nome da maratona não pode estar em branco.');
        return;
    }

    if (new Date(dataFim) < new Date(dataInicio)) {
        alert('A data final não pode ser menor que a data inicial.');
        return;
    }

    if (capituloFinal < capituloAtual) {
        alert('O capítulo final não pode ser menor que o capítulo atual.');
        return;
    }

    verificarNomeMaratonaExistente(nomeMaratona, clubeId)
        .then(nomeExistente => {
            if (nomeExistente) {
                alert('Já existe uma maratona com este nome. Por favor, escolha um nome diferente.');
                return;
            }

            fetch(`/clube/${clubeId}/criar_maratona/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    nome_maratona: nomeMaratona,
                    data_fim: dataFim,
                    data_inicio: dataInicio,
                    capitulo_final: capituloFinal,
                    capitulo_atual: capituloAtual,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    carregarDadosMaratona(clubeId); 
                    location.reload(true);
                } else {
                    alert('Erro ao salvar maratona: ' + data.message);
                    console.error('Erro:', data);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
            });
        });
});

function verificarNomeMaratonaExistente(nomeMaratona, clubeId) {
    return fetch(`/clube/${clubeId}/listar_historico_maratona/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                return data.historico.some(historico => historico.nome_maratona === nomeMaratona);
            } else {
                throw new Error('Erro ao carregar histórico.');
            }
        })
        .catch(error => {
            console.error('Erro na verificação do nome da maratona:', error);
            return false; 
        });
}


function calcularDuracao(dataInicio, dataFim) {
    const inicio = new Date(dataInicio);
    const fim = new Date(dataFim);
    const duracao = Math.abs(fim - inicio);
    const dias = Math.ceil(duracao / (1000 * 60 * 60 * 24));
    return dias;
}

function calcularTotalCapitulos(capituloFinal, capituloAtual) {
    return capituloFinal - capituloAtual;
}

document.getElementById('createMaratona').addEventListener('click', function(event) {
    const createButton = event.currentTarget;
    const clubeId = createButton.getAttribute('data-clube-id');

    if (!clubeId) {
        console.error('Clube ID não encontrado.');
        return;
    }

    carregarDadosMaratona(clubeId); 
});


window.onload = function() {
    const createButton = document.getElementById('createMaratona');
    const clubeId = createButton.getAttribute('data-clube-id');
    if (clubeId) {
        carregarDadosMaratona(clubeId);
    }
};



    document.addEventListener('DOMContentLoaded', function() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dataInicio').value = today;
            });

document.querySelectorAll('.top-books-li').forEach((scrollContainer) => {
  let isDown = false;
  let startX;
  let scrollLeft;

  scrollContainer.addEventListener('mousedown', (e) => {
    isDown = true;
    scrollContainer.classList.add('active');
    startX = e.pageX - scrollContainer.offsetLeft;
    scrollLeft = scrollContainer.scrollLeft;
  });

  scrollContainer.addEventListener('mouseleave', () => {
    isDown = false;
    scrollContainer.classList.remove('active');
  });

  scrollContainer.addEventListener('mouseup', () => {
    isDown = false;
    scrollContainer.classList.remove('active');
  });

  scrollContainer.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - scrollContainer.offsetLeft;
    const walk = (x - startX) * 3;
    scrollContainer.scrollLeft = scrollLeft - walk;
  });
});

    
</script>

{% endblock %}